<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Conversations Viewer</title>
    <!-- Add highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/php.min.js"></script>

    <!-- Add marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* CSS Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #6e56cf;
            --primary-light: #f0ebff;
            --primary-dark: #5a45b0;
            --bg-color: #f9f9f9;
            --text-color: #333;
            --text-muted: #666;
            --border-color: #eee;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --spacing-sm: 8px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        /* Typography */
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xl);
        }

        h2 {
            margin-top: 0;
            margin-bottom: var(--spacing-sm);
            color: var(--primary-color);
        }

        /* Layout components */
        .language-toggle {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .language-btn {
            padding: 5px 10px;
            background-color: var(--primary-light);
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            color: var(--primary-color);
        }

        .language-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            background-color: var(--primary-light);
        }

        .file-input {
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .file-input label {
            font-size: 18px;
            margin-bottom: var(--spacing-md);
            display: block;
        }

        input[type="file"] {
            margin-bottom: var(--spacing-md);
        }

        .buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        button {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        .conversations-container {
            display: flex;
            height: calc(100vh - 200px);
            gap: var(--spacing-lg);
        }

        .conversation-list,
        .messages-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-y: auto;
        }

        .conversation-list {
            width: 30%;
            flex-shrink: 0;
        }

        .messages-container {
            flex-grow: 1;
            padding: var(--spacing-lg);
        }

        /* Conversation items */
        .conversation-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .conversation-item:hover {
            background-color: var(--primary-light);
        }

        .conversation-item.active {
            background-color: #e0d6ff;
            border-left: 4px solid var(--primary-color);
        }

        .conversation-title {
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Message styling */
        .message {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            max-width: 95%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .message.user {
            background-color: #e0d6ff;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .message.assistant {
            background-color: #f0f0f0;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }

        .message-sender {
            font-weight: 600;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .message-content {
            white-space: normal;; /* //pre-wrap */
        }

        /* Style for markdown content */
        .message-content p {
            margin-bottom: 1em;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }

        .message-content ul,
        .message-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .message-content blockquote {
            border-left: 3px solid #ccc;
            padding-left: 1em;
            margin-left: 0;
            color: #666;
        }

        .message-content table {
            border-collapse: collapse;
            margin-bottom: 1em;
            width: 100%;
        }

        .message-content th,
        .message-content td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .message-content th {
            background-color: #f5f5f5;
        }

        .message-section {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px dashed #ddd;
        }

        /* Conversation info */
        .conversation-info {
            padding: var(--spacing-md);
            background-color: var(--primary-light);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
        }

        /* Stats */
        .stats {
            margin-top: var(--spacing-lg);
            text-align: center;
            color: var(--text-muted);
        }

        /* Status messages */
        .loading,
        .empty-state {
            text-align: center;
            color: var(--text-muted);
        }

        .loading {
            padding: var(--spacing-xl);
            font-style: italic;
        }

        .empty-state {
            padding: 50px var(--spacing-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            margin: auto;
        }

        .empty-state p {
            margin-bottom: var(--spacing-xl);
        }

        /* Code formatting */
        code {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        pre {
            background: #f0f0f0;
            padding: var(--spacing-sm);
            border-radius: 5px;
            overflow-x: auto;
            margin: var(--spacing-sm) 0;
        }

        .hljs {
            padding: var(--spacing-md);
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.4;
            font-size: 14px;
        }

        /* Artifacts */
        .artifact {
            background: #fff5e6;
            border: 1px solid #ffcc80;
            border-radius: 5px;
            padding: var(--spacing-md);
            margin: var(--spacing-sm) 0;
        }

        .artifact-header {
            font-weight: bold;
            color: #ff9800;
            margin-bottom: 5px;
        }

        .artifact-content {
            max-height: 500px;
            overflow-y: auto;
            background: #fff;
            padding: var(--spacing-sm);
            border-radius: 3px;
            border: 1px solid #eee;
        }

        .artifact-file {
            font-style: italic;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .conversations-container {
                flex-direction: column;
                height: auto;
            }

            .conversation-list {
                width: 100%;
                margin-bottom: var(--spacing-lg);
                max-height: 300px;
            }

            .message {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="language-toggle">
    <button id="en-btn" class="language-btn active">English</button>
    <button id="fr-btn" class="language-btn">Français</button>
</div>

<h1 id="app-title">Claude Conversations Viewer</h1>

<div class="controls">
    <div class="file-input">
        <label for="file-input" id="file-label">Select your conversations.json file</label>
        <input type="file" id="file-input" accept=".json">
    </div>
    <div class="buttons">
        <button id="load-button">Load Conversations</button>
    </div>
</div>

<div class="stats" id="stats"></div>

<div class="conversations-container" id="conversations-container">
    <div class="empty-state">
        <p id="empty-state-text">Please load your conversations.json file to begin.</p>
        <p id="empty-state-desc">This file comes from a Claude AI export and contains the history of your
            conversations.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let conversationsData = [];
        let currentLanguage = 'en'; // Default language is English

        const translations = {
            en: {
                appTitle: 'Claude Conversations Viewer',
                fileLabel: 'Select your conversations.json file',
                loadButton: 'Load Conversations',
                emptyStateText: 'Please load your conversations.json file to begin.',
                emptyStateDesc: 'This file comes from a Claude AI export and contains the history of your conversations.',
                errorLoading: 'Error loading JSON file:',
                noConversations: 'No conversations found in the file.',
                selectConversation: 'Select a conversation to view messages.',
                conversationsFound: 'conversations found',
                noMessages: 'No messages in this conversation.',
                createdDate: 'Created:',
                updatedDate: 'Last updated:',
                you: 'You',
                untitled: 'Untitled'
            },
            fr: {
                appTitle: 'Visualiseur de Conversations Claude',
                fileLabel: 'Sélectionnez votre fichier conversations.json',
                loadButton: 'Charger les conversations',
                emptyStateText: 'Veuillez charger votre fichier conversations.json pour commencer.',
                emptyStateDesc: 'Ce fichier provient d\'un export de Claude AI et contient l\'historique de vos conversations.',
                errorLoading: 'Erreur lors du chargement du fichier JSON:',
                noConversations: 'Aucune conversation trouvée dans le fichier.',
                selectConversation: 'Sélectionnez une conversation pour afficher les messages.',
                conversationsFound: 'conversations trouvées',
                noMessages: 'Aucun message dans cette conversation.',
                createdDate: 'Date de création:',
                updatedDate: 'Dernière mise à jour:',
                you: 'Vous',
                untitled: 'Sans titre'
            }
        };

        const fileInput = document.getElementById('file-input');
        const loadButton = document.getElementById('load-button');
        const conversationsContainer = document.getElementById('conversations-container');
        const statsElement = document.getElementById('stats');
        const enButton = document.getElementById('en-btn');
        const frButton = document.getElementById('fr-btn');

        // Language toggle functionality
        enButton.addEventListener('click', function () {
            setLanguage('en');
        });

        frButton.addEventListener('click', function () {
            setLanguage('fr');
        });

		// Add event listener for the 'change' event
		fileInput.addEventListener('change', handleFileSelect);
		
		// read immediately upon file select
		function handleFileSelect(event) {
			const file = event.target.files[0]; // Get the selected file
			if (file) {
			readConversations();
			}
		}
        
        function setLanguage(lang) {
            currentLanguage = lang;

            // Update UI to reflect language
            if (lang === 'en') {
                enButton.classList.add('active');
                frButton.classList.remove('active');
            } else {
                enButton.classList.remove('active');
                frButton.classList.add('active');
            }

            // Update all text elements
            document.getElementById('app-title').textContent = translations[lang].appTitle;
            document.getElementById('file-label').textContent = translations[lang].fileLabel;
            document.getElementById('load-button').textContent = translations[lang].loadButton;

            // Update empty state text if it's currently showing
            const emptyStateElement = document.querySelector('.empty-state');
            if (emptyStateElement) {
                const paragraphs = emptyStateElement.querySelectorAll('p');
                if (paragraphs.length >= 2) {
                    paragraphs[0].textContent = translations[lang].emptyStateText;
                    paragraphs[1].textContent = translations[lang].emptyStateDesc;
                }
            }

            // If conversations are loaded, update the stats text and redisplay current conversation
            if (conversationsData.length > 0) {
                statsElement.textContent = `${conversationsData.length} ${translations[lang].conversationsFound}`;

                // If a conversation is selected, redisplay it with the new language
                const activeItem = document.querySelector('.conversation-item.active');
                if (activeItem) {
                    const conversationIndex = parseInt(activeItem.getAttribute('data-index'));
                    displayMessages(conversationsData[conversationIndex]);
                }
            }
        }

        // Configure marked.js options
        marked.setOptions({
            breaks: true,          // Add line breaks on single line breaks
            gfm: true,             // Enable GitHub Flavored Markdown
            headerIds: false,      // Disable adding IDs to headings
            mangle: false          // Disable escaping certain characters
        });

        loadButton.addEventListener('click', readConversations);
        function readConversations() {
            const file = fileInput.files[0];
            if (!file) {
                alert(translations[currentLanguage].fileLabel);
                return;
            }

            const loadingText = currentLanguage === 'en' ? 'Loading conversations...' : 'Chargement des conversations...';
            conversationsContainer.innerHTML = `<div class="loading">${loadingText}</div>`;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    conversationsData = JSON.parse(e.target.result);
                    renderConversations(conversationsData);
                } catch (error) {
                    alert(`${translations[currentLanguage].errorLoading} ${error.message}`);
                    const errorText = currentLanguage === 'en'
                        ? 'An error occurred while loading. Please check that the file is in the correct format.'
                        : 'Une erreur est survenue lors du chargement. Veuillez vérifier que le fichier est au bon format.';
                    conversationsContainer.innerHTML = `<div class="empty-state"><p>${errorText}</p></div>`;
                }
            };
            reader.readAsText(file);
        });

        function renderConversations(data) {
            if (!Array.isArray(data) || data.length === 0) {
                conversationsContainer.innerHTML = `<div class="empty-state"><p>${translations[currentLanguage].noConversations}</p></div>`;
                return;
            }

            // Display statistics
            statsElement.textContent = `${data.length} ${translations[currentLanguage].conversationsFound}`;

            // Create UI elements
            conversationsContainer.innerHTML = `
                <div class="conversation-list" id="conversation-list"></div>
                <div class="messages-container" id="messages-container">
                    <div class="empty-state">
                        <p>${translations[currentLanguage].selectConversation}</p>
                    </div>
                </div>
            `;

            const conversationList = document.getElementById('conversation-list');

            // Sort conversations by date (newest first)
            data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // Add conversations to the list
            data.forEach((conversation, index) => {
                const conversationItem = document.createElement('div');
                conversationItem.className = 'conversation-item';
                conversationItem.setAttribute('data-index', index);

                const date = new Date(conversation.created_at);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                conversationItem.innerHTML = `
                    <div class="conversation-title">${conversation.name || translations[currentLanguage].untitled}</div>
                    <div class="conversation-date">${formattedDate}</div>
                `;

                conversationItem.addEventListener('click', function () {
                    // Deselect previously active item
                    const activeItems = document.querySelectorAll('.conversation-item.active');
                    activeItems.forEach(item => item.classList.remove('active'));

                    // Select this item
                    this.classList.add('active');

                    // Display messages for this conversation
                    const conversationIndex = parseInt(this.getAttribute('data-index'));
                    displayMessages(data[conversationIndex]);
                });

                conversationList.appendChild(conversationItem);
            });

            // Automatically select the first conversation
            if (conversationList.firstChild) {
                conversationList.firstChild.click();
            }
        }

        function displayMessages(conversation) {
            const messagesContainer = document.getElementById('messages-container');

            if (!conversation || !conversation.chat_messages || conversation.chat_messages.length === 0) {
                messagesContainer.innerHTML = `<div class="empty-state"><p>${translations[currentLanguage].noMessages}</p></div>`;
                return;
            }

            let messagesHTML = `
                <div class="conversation-info">
                    <h2>${conversation.name || translations[currentLanguage].untitled}</h2>
                    <div>${translations[currentLanguage].createdDate} ${formatDate(conversation.created_at)}</div>
                    <div>${translations[currentLanguage].updatedDate} ${formatDate(conversation.updated_at)}</div>
                </div>
            `;

            conversation.chat_messages.forEach(message => {
                const isUser = message.sender === 'human';
                const messageClass = isUser ? 'user' : 'assistant';
                const senderName = isUser ? translations[currentLanguage].you : 'Claude';

                messagesHTML += `
                    <div class="message ${messageClass}">
                        <div class="message-header">
                            <span class="message-sender">${senderName}</span>
                            <span class="message-time">${formatDate(message.created_at)}</span>
                        </div>
                        <div class="message-content">
                `;

                if (message.content && Array.isArray(message.content)) {
                    messagesHTML += processMessageContent(message.content);
                } else if (message.text) {
                    messagesHTML += formatMessageContent(message.text);
                }

                messagesHTML += `
                        </div>
                    </div>
                `;
            });

            messagesContainer.innerHTML = messagesHTML;

            // Apply syntax highlighting to all code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });

            // Scroll to the bottom to see the most recent messages
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // This code should be integrated into the processMessageContent function

        function processMessageContent(contentArray) {
            let result = '';

            contentArray.forEach(contentItem => {
                if (contentItem.type === 'text') {
                    // Get the original text
                    let text = contentItem.text;

                    // Parse and extract artifacts from the text
                    let parts = extractArtifacts(text);

                    // Process each part (either regular text or artifact)
                    parts.forEach(part => {
                        if (part.type === 'text') {
                            result += `<div class="message-section">${formatMessageContent(part.content)}</div>`;
                        } else if (part.type === 'artifact') {
                            result += generateArtifactHTML(part.artifact);
                        }
                    });
                } else if (contentItem.type === 'tool_use') {
                    if (contentItem.name === 'artifacts') {
                        result += processArtifact(contentItem);
                    } else if (contentItem.name === 'repl') {
                        // Handle repl tool use
                        result += `<div class="message-section"><strong>Analysis</strong><pre><code class="language-javascript">${escapeHtml(contentItem.input.code.trim())}</code></pre></div>`;
                    }
                } else if (contentItem.type === 'tool_result') {
                    if (contentItem.name !== 'artifacts') {
                        try {
                            // Try to parse the logs from the tool result
                            let logs = JSON.parse(contentItem.content[0].text).logs;
                            result += `<div class="message-section"><strong>Result</strong><pre>${escapeHtml(logs.join("\n"))}</pre></div>`;
                        } catch (e) {
                            // Fallback if parsing fails
                            result += `<div class="message-section"><strong>Result</strong><pre>${escapeHtml(contentItem.content[0].text)}</pre></div>`;
                        }
                    }
                }
            });

            return result;
        }

        // Function to extract artifacts from text content
        function extractArtifacts(text) {
            const parts = [];
            let currentIndex = 0;

            // Regular expression to match antArtifact tags
            const artifactRegex = /<antArtifact([^>]*)>([\s\S]*?)<\/antArtifact>/g;
            let match;

            while ((match = artifactRegex.exec(text)) !== null) {
                // If there's text before the artifact, add it
                if (match.index > currentIndex) {
                    parts.push({
                        type: 'text',
                        content: text.substring(currentIndex, match.index)
                    });
                }

                // Extract artifact attributes
                const attributesStr = match[1];
                const attributesRegex = /(\w+)=["']([^"']*)["']/g;
                const artifact = {
                    content: match[2],
                    attributes: {}
                };

                let attrMatch;
                while ((attrMatch = attributesRegex.exec(attributesStr)) !== null) {
                    artifact.attributes[attrMatch[1]] = attrMatch[2];
                }

                // Add the artifact
                parts.push({
                    type: 'artifact',
                    artifact: artifact
                });

                // Update current position
                currentIndex = match.index + match[0].length;
            }

            // Add any remaining text
            if (currentIndex < text.length) {
                parts.push({
                    type: 'text',
                    content: text.substring(currentIndex)
                });
            }

            return parts;
        }

        // Function to generate HTML for an artifact
        function generateArtifactHTML(artifact) {
            const {attributes, content} = artifact;

            let artifactHTML = '<div class="artifact">';

            // Display identifier as header if available
            if (attributes.identifier) {
                artifactHTML += `<div class="artifact-header">Artifact: ${attributes.identifier}</div>`;
            }

            // Display title if available
            if (attributes.title) {
                artifactHTML += `<div class="artifact-file">${attributes.title}</div>`;
            }

            // Process content based on type
            const type = attributes.type || 'text/plain';

            if (type === 'text/markdown') {
                artifactHTML += `<div class="artifact-content">${formatMessageContent(content)}</div>`;
            } else if (type === 'application/vnd.ant.code' || type.startsWith('text/')) {
                // Determine language for syntax highlighting
                let language = '';
                if (type === 'text/html') language = 'html';
                else if (type === 'text/css') language = 'css';
                else if (type === 'text/javascript') language = 'javascript';

                artifactHTML += `<div class="artifact-content">
                    <pre><code class="${language}">${escapeHtml(content)}</code></pre>
                </div>`;
            } else {
                // Default display for unknown types
                artifactHTML += `<div class="artifact-content"><pre><code>${escapeHtml(content)}</code></pre></div>`;
            }

            artifactHTML += '</div>';
            return artifactHTML;
        }

        function processArtifact(artifact) {
            if (!artifact.input) return '';

            const typeLookup = {
                'text/markdown': 'markdown',
                'application/vnd.ant.code': '',
                'text/html': 'html',
                'image/svg+xml': 'svg',
                'application/vnd.ant.mermaid': 'mermaid',
                'application/vnd.ant.react': 'jsx'
            };

            let artifactHTML = '<div class="artifact">';
            artifactHTML += `<div class="artifact-header">Artifact: ${artifact.input.id}</div>`;

            const command = artifact.input.command;

            // Display title or file type
            if (artifact.input.title) {
                artifactHTML += `<div class="artifact-file">${artifact.input.title}</div>`;
            } else if (artifact.input.language) {
                artifactHTML += `<div class="artifact-file">File type: ${artifact.input.language}</div>`;
            }

            // Process based on command (create, rewrite, update)
            if (command === 'create' || command === 'rewrite') {
                if (artifact.input.content) {
                    if (artifact.input.type === 'text/markdown') {
                        artifactHTML += `<div class="artifact-content">${formatMessageContent(artifact.input.content)}</div>`;
                    } else if (artifact.input.type === 'application/vnd.ant.code' || artifact.input.language) {
                        // Determine language for syntax highlighting
                        let language = '';
                        if (artifact.input.language) {
                            language = artifact.input.language.toLowerCase();
                        } else if (artifact.input.type) {
                            language = typeLookup[artifact.input.type] || '';
                        }

                        artifactHTML += `<div class="artifact-content">
                            <pre><code class="${language}">${escapeHtml(artifact.input.content)}</code></pre>
                        </div>`;
                    } else {
                        artifactHTML += `<div class="artifact-content"><pre><code>${escapeHtml(artifact.input.content)}</code></pre></div>`;
                    }
                }
            } else if (command === 'update') {
                // Special display for updates
                const findHeader = currentLanguage === 'en' ? 'Find this:' : 'Trouver ceci:';
                const replaceHeader = currentLanguage === 'en' ? 'Replace with this:' : 'Remplacer par ceci:';

                artifactHTML += `<div class="artifact-update">
                    <div class="update-section">
                        <h4>${findHeader}</h4>
                        <pre><code>${escapeHtml(artifact.input.old_str)}</code></pre>
                    </div>
                    <div class="update-section">
                        <h4>${replaceHeader}</h4>
                        <pre><code>${escapeHtml(artifact.input.new_str)}</code></pre>
                    </div>
                </div>`;
            }

            artifactHTML += '</div>';
            return artifactHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatMessageContent(text) {
            if (!text) return '';
            text = text.replace("```php", "```html");
            // Simplified approach for HTML detection and display
            const hasHtmlMarkup = (str) => {
                return /<(!DOCTYPE|html|head|body|div|nav|section|script|style)[^>]*>/i.test(str);
            };

            // If it's obviously HTML and not in a markdown code block
            if (hasHtmlMarkup(text) && !text.includes('```html')) {
                return `<pre><code class="language-html">${escapeHtml(text)}</code></pre>`;
            }

            // Configure markdown renderer
            const renderer = new marked.Renderer();

            // Handle code blocks
            renderer.code = function (code, language) {
                // Make sure language isn't undefined
                const validLanguage = language || '';
                const escapedCode = escapeHtml(code.text);

                try {
                    if (validLanguage && hljs.getLanguage(validLanguage)) {
                        const highlighted = hljs.highlight(escapedCode, {
                            language: validLanguage,
                            ignoreIllegals: true
                        }).value;
                        return `<pre><code class="hljs ${validLanguage}">${highlighted}</code></pre>`;
                    } else {
                        // If language isn't specified or not supported
                        return `<pre><code class="hljs">${escapedCode}</code></pre>`;
                    }
                } catch (e) {
                    console.error("Highlight error:", e);
                    return `<pre><code class="hljs">${escapedCode}</code></pre>`;
                }
            };

            // Set marked options
            marked.setOptions({
                renderer: renderer,
                gfm: true,
                breaks: true,
                sanitize: false,
                smartypants: false
            });

            return marked.parse(text);
        }

        // Robust HTML escape function
        function escapeHtml(text) {
            if (!text) return '';

            if (typeof text !== 'string') {
                text = String(text);
            }

            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Initialize highlight.js
        hljs.configure({
            languages: ['javascript', 'python', 'java', 'html', 'css', 'xml', 'json', 'bash', 'typescript', 'sql', 'php']
        });
    });
</script>
</body>
</html>
